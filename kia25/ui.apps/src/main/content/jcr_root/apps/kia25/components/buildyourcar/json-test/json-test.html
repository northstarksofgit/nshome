<sly data-sly-use.clientLib="/libs/granite/sightly/templates/clientlib.html"  data-sly-call="${clientLib.all @ categories='kia25.base'}"></sly>


<html>

<head>
  <title>Welcome to Vue</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <style>
    tr {
      cursor: grab;
    }
  </style>
</head>

<body>
  <div id="app">
<!-- 
	<v-container>
      <h1 class="text-xs-center mt-3">Drag n Drop</h1>
      <p style="margin-top: 1em;">마우스로 드래그&드롭하여 순서를 바꿀 수 있습니다.</p>
      <v-layout style="margin-top: 3em;" mt-5 justify-center>
        <v-flex sm8>
          <v-data-table :key="reRender" :headers="headers" :items="formItems" class="elevation-1">
            <template slot="items" slot-scope="props">
              <td class="text-xs-left">{{ props.item.name }}</td>
              <td class="text-xs-left">{{ props.item.score }}</td>
            </template>
          </v-data-table>
        </v-flex>
      </v-layout>

      <v-layout style="margin-top: 5em;">

        <v-flex sm12>
          <h2>The items in the "dragNdrop" array</h2>
          <p>
            {{JSON.stringify(dragNdrop, null,'\n')}}
          </p>
        </v-flex>
      </v-layout>

    </v-container>
-->


<v-card>
	<v-card-title>
      {{ trimName }} &nbsp;&nbsp;
      <v-spacer></v-spacer>
      <v-text-field
        v-model="search"
        append-icon="mdi-magnify"
        label="Search"
        single-line
        hide-details
        cols="4"
      ></v-text-field>
    </v-card-title>
	<v-data-table 
		data-app
		:search="search"
    	:headers="headers"
    	:items="optionList"
    	sort-by="calories"
    	class="elevation-1"
  	>
    
    	<v-toolbar
        	flat
      	>
        <v-toolbar-title>{{ trimName }} &nbsp;&nbsp;</v-toolbar-title>
        <v-divider
        	class="mx-4"
          	inset
          	vertical
        ></v-divider>
        <v-spacer></v-spacer>
        <v-dialog
          	v-model="dialog"
          	max-width="500px"
        >
        
          <template v-slot:activator="{ on, attrs }">
          	<v-btn
            	color="primary"
             	dark
              	class="mb-2"
				@click="init"
            >
            	Search
            </v-btn>
          </template>
          <v-card>
          	<v-card-title>
              <span class="text-h5">{{ formTitle }}</span>
            </v-card-title>

            <v-card-text>
              <v-container>
                <v-row>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.optionCode"
                      label="Option Code"
                    ></v-text-field>
                  </v-col>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.optionName"
                      label="Option Name"
                    ></v-text-field>
                  </v-col>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.optionPrice"
                      label="Option Price"
                      type="number"
                    ></v-text-field>
                  </v-col>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.bestYn"
                      label="Best Y/N"
                    ></v-text-field>
                  </v-col>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.optionImagePath"
                      label="Option Image Path"
                    ></v-text-field>
                  </v-col>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.sortOrder"
                      label="Sort Order"
                      type="number"
                    ></v-text-field>
                  </v-col>
                  <v-col
                    cols="12"
                    sm="12"
                    md="12"
                  >
                    <v-text-field
                      v-model="editedItem.useYn"
                      label="Use Y/N"
                    ></v-text-field>
                  </v-col>
                </v-row>
              </v-container>
            </v-card-text>

            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn
                color="blue darken-1"
                text
                @click="close"
              >
                Cancel
              </v-btn>
              <v-btn
                color="blue darken-1"
                text
                @click="save"
              >
                Save
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
        
        <v-dialog v-model="dialogDelete" max-width="500px">
          <v-card>
            <v-card-title class="text-h5">Are you sure you want to delete this item?</v-card-title>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn color="blue darken-1" text @click="closeDelete">Cancel</v-btn>
              <v-btn color="blue darken-1" text @click="deleteItemConfirm">OK</v-btn>
              <v-spacer></v-spacer>
            </v-card-actions>
          </v-card>
        </v-dialog>
        
      </v-toolbar>
    </template>
    
    <template v-slot:item.actions="{ item }">
      <v-icon
        small
        class="mr-2"
        @click="editItem(item)"
      >
        	수정
      </v-icon>
      <v-icon
        small
        @click="deleteItem(item)"
      >
        	삭제
      </v-icon>
    </template>
    <template v-slot:no-data>
      <v-btn
        color="primary"
      >
<!--       <v-btn -->
<!--         color="primary" -->
<!--         @click="initialize" -->
<!--       > -->
        No Data
      </v-btn>
    </template>
  </v-data-table>
	
	</v-card>
	
  </div>
  
  
   <script>
   $(function() {
    var app = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: {
//         reRender: 0,
        dragNdrop: [],
		url : null,
		urlParams : null,
		trimCode : null,
		trimName : null,
		optionListURL : null,
		dataObj : null,
		carOptionCode : null,
        
		select: null,
        items: null,
        
        
        search: '',
        
        dialog: false,
        dialogDelete: false,
        headers: [
          {
            text: '옵션 코드',
            align: 'start',
            sortable: false,
            value: 'optionCode',
            filterable: false
          },
          { text: '옵션 명', value: 'optionName' },
          { text: '옵션 가격', value: 'optionPrice', filterable: false },
          { text: '추천 여부', value: 'bestYn', filterable: false },
          { text: '옵션 이미지', value: 'optionImagePath', filterable: false },
          { text: '정렬 순서', value: 'sortOrder', filterable: false },
          { text: '사용 여부', value: 'useYn', filterable: false },
          { text: 'Actions', value: 'actions', sortable: false, filterable: false },
        ],
        optionList: [],
        editedIndex: -1,
        editedItem: {
        	optionCode: '',
        	optionName: '',
        	optionPrice: null,
        	bestYn: '',
        	optionImagePath: '',
        	sortOrder: null,
        	useYn: ''
        },
        defaultItem: {
        	optionCode: '',
        	optionName: '',
        	optionPrice: null,
        	bestYn: '',
        	optionImagePath: '',
        	sortOrder: null,
        	useYn: ''
        },
      },
      methods: {
    	    changeSelect(value) {
    	    	console.log(value);
// 	    		return value;
			},
    	  
			initSortable() {
          		let table = document.querySelector("tbody");
          		const _self = this;
          		// this way we avoid data binding
          		

          		Sortable.create(table, {
            		onEnd({newIndex, oldIndex}) {
            			console.log(newIndex, oldIndex);
            			
          				_self.dragNdrop = JSON.parse(JSON.stringify(_self.optionList));
          				
						_self.dragNdrop.splice(newIndex, 0, ..._self.dragNdrop.splice(oldIndex, 1));
						
						console.log(_self.dragNdrop);
            		}
          		});
        	},

        	init : function() { //start init()
				var ref = this;
				var carOptionCode = $("#soflow option:selected").val();
				
// 				var data = {
// 						"trimCode" : this.trimCode,
// 						"carOptionCode": carOptionCode
// 				}

				var data = {
						"trimCode" : this.trimCode,
						"carOptionCode": this.carOptionCode
				}
				
				data = JSON.stringify(data)
				$.ajax({
					type:"POST",
					url : this.optionListURL + "list",
					data: {
						data : data
					},
					success:function(result){
						console.log(result);		
						var dataList = result.list;
						var select = result.select;
						$('.option-list-table').empty();
						
						for(var i=0; i<dataList.length; i++) {
							dataList[i].optionPrice = dataList[i].optionPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
						}
						
						ref.trimName = select.trimName;
						
						ref.optionList = dataList;
// 						ref.drawTable(dataList, select);
// 						ref.filtering()
// 						ref.bindEvent();
					},
					beforeSend: function() { //로딩이미지 보여주기
						$("#modal-wrap-loading").show();
					    $("#wrap-loading").show();
					},
					complete: function() { //로딩이미지 숨기기
						$("#modal-wrap-loading").hide();
					    $("#wrap-loading").hide();
					}
				})		
			}, //end init()
        		

              editItem (item) {
				item.optionPrice = parseInt(item.optionPrice.replaceAll(',','')); 
				
                this.editedIndex = this.optionList.indexOf(item)
                this.editedItem = Object.assign({}, item)
                this.dialog = true
              },

              deleteItem (item) {
                this.editedIndex = this.optionList.indexOf(item)
                this.editedItem = Object.assign({}, item)
                this.dialogDelete = true
              },

              deleteItemConfirm () {
                this.optionList.splice(this.editedIndex, 1)
                this.closeDelete()
              },

              close () {
                this.dialog = false
                this.$nextTick(() => {
                  this.editedItem = Object.assign({}, this.defaultItem)
                  this.editedIndex = -1
                })
              },

              closeDelete () {
                this.dialogDelete = false
                this.$nextTick(() => {
                  this.editedItem = Object.assign({}, this.defaultItem)
                  this.editedIndex = -1
                })
              },

              save () {
                if (this.editedIndex > -1) {
                  Object.assign(this.optionList[this.editedIndex], this.editedItem)
                } else {
                  this.optionList.push(this.editedItem)
                }
                this.close()
              }
      },
      mounted() {
        this.init();
        this.initSortable();
      },
      computed: {
          formTitle () {
            return this.editedIndex === -1 ? 'New Item' : 'Edit Item'
          },
        },

      watch: {
        dialog (val) {
          val || this.close()
        },
        dialogDelete (val) {
          val || this.closeDelete()
        },
      },
      created() {
   	  	this.url = new URL(window.location.href);
		this.urlParams = this.url.searchParams;
		this.trimCode = this.urlParams.get('trimCode');
		this.optionListURL = "/services/option/";
		this.dataObj = null;
		this.select = { state: '옵션', carOptionCode: 'O' },
        this.items = [
          { state: '옵션', carOptionCode: 'O' },
          { state: '패키지', carOptionCode: 'P' },
        ]
		this.carOptionCode = this.select.carOptionCode;
      }
    })
   })
  </script>
</body>

</html>